version: '3.9'

services:
  teacher_web:
    container_name: teacher_web
    build:
      context: ./infra/docker/web/teacher
      dockerfile: Dockerfile.development
    working_dir: /var/web
    volumes:
      - ./web/teacher:/var/web:cached
    ports:
      - 3000:3000
    environment:
      - API_URL=${TEACHER_API_URL}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID}
    command: yarn dev -H 0.0.0.0 -p 3000

  teacher_gateway:
    container_name: teacher_gateway
    build:
      context: .
      dockerfile: ./infra/docker/api/gateway/teacher/Dockerfile.development
    working_dir: /go/src/github.com/calmato/shs-web/api
    volumes:
      - ./api:/go/src/github.com/calmato/shs-web/api:cached
      - ./tmp/data/go/pkg/mod:/go/pkg/mod:delegated
      - ./tmp/logs/gateway/teacher:/var/log/api:delegated
    environment:
      - PORT=8080
      - METRICS_PORT=9090
      - SHUTDOWN_DELAY_SEC=0
      - LOG_PATH=/var/log/api
      - GCP_SERVICE_KEY_JSON=${GCP_SERVICE_KEY_JSON}
      - GCP_STORAGE_BUCKET_NAME=${GCP_STORAGE_BUCKET_NAME}
      - USER_SERVICE_URL=user_api:8080
    ports:
      - 18000:8080
      - 18001:9090
    command: make dev SERVICE=gateway/teacher

  user_api:
    container_name: user_api
    build:
      context: .
      dockerfile: ./infra/docker/api/user/server/Dockerfile.development
    working_dir: /go/src/github.com/calmato/shs-web/api
    volumes:
      - ./api:/go/src/github.com/calmato/shs-web/api:cached
      - ./tmp/data/go/pkg/mod:/go/pkg/mod:delegated
      - ./tmp/logs/gateway/teacher:/var/log/api:delegated
    environment:
      - PORT=8080
      - METRICS_PORT=9090
      - SHUTDOWN_DELAY_SEC=0
      - LOG_PATH=/var/log/api
      - GCP_SERVICE_KEY_JSON=${GCP_SERVICE_KEY_JSON}
      - GCP_STORAGE_BUCKET_NAME=${GCP_STORAGE_BUCKET_NAME}
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - 19000:8080
      - 19001:9090
    command: make dev SERVICE=user/server

  mysql:
    container_name: mysql
    platform: linux/x86_64
    build:
      context: ./infra/docker/infra/mysql
      dockerfile: Dockerfile
    volumes:
      - ./infra/mysql/development.cnf:/etc/mysql/conf.d/my.cnf
      - ./infra/mysql/schema:/docker-entrypoint-initdb.d
      - ./tmp/logs/mysql:/var/log/mysql:delegated
      - ./tmp/data/mysql:/var/lib/mysql:delegated
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - 3316:3306

  mysql_test:
    container_name: mysql_test
    platform: linux/x86_64
    build:
      context: ./infra/docker/infra/mysql
      dockerfile: Dockerfile
    volumes:
      - ./infra/mysql/test.cnf:/etc/mysql/conf.d/my.cnf
      - ./infra/mysql/schema:/docker-entrypoint-initdb.d
      - ./tmp/logs/mysql_test:/var/log/mysql:delegated
      - ./tmp/data/mysql_test:/var/lib/mysql:delegated
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - 3326:3306

  firebase_test:
    container_name: firebase_test
    platform: linux/x86_64
    build:
      context: ./infra/docker/infra/firebase
      dockerfile: Dockerfile
    working_dir: /var/firebase
    volumes:
      - ./infra/firebase:/var/firebase:cached
    ports:
      - 4000:4000
      - 8080:8080
      - 9099:9099

  proto:
    container_name: proto
    platform: linux/x86_64
    build:
      context: ./infra/docker/infra/proto
      dockerfile: Dockerfile
    working_dir: /go/src/github.com/calmato/shs-web
    volumes:
      - ./api:/go/src/github.com/calmato/shs-web/api:cached
      - ./tmp/data/go/pkg/mod:/go/pkg/mod:delegated

  swagger_generator:
    container_name: swagger_generator
    build:
      context: ./infra/docker/infra/swagger/generator
      dockerfile: Dockerfile
    working_dir: /var/swagger/src
    volumes:
      - ./docs/swagger:/var/swagger/src:cached
      - ./tmp/data/swagger:/tmp/data/swagger:cached
    command: yarn watch

  swagger_teacher:
    container_name: swagger_ui_teacher
    build:
      context: ./infra/docker/infra/swagger/teacher
      dockerfile: Dockerfile
    volumes:
      - ./tmp/data/swagger/teacher/openapi:/var/swagger:cached
    ports:
      - 9000:8080
    environment:
      SWAGGER_JSON: /var/swagger/openapi.yaml
    depends_on:
      - swagger_generator
